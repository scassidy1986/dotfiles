#!/usr/bin/env sh

DEFAULT_NAMESPACE="kube-system"

function banner () {
  echo "=========================================="
}

function usage () {
  script=$(basename "${0}")
  echo "Usage: ${script} -s <secret> -n <namespace>"
  echo "   -s the secret to retrieve"
  echo "   -n the namespace to search. Defaults to ${DEFAULT_NAMESPACE}"
}

secret=""
namespace=${DEFAULT_NAMESPACE}
while getopts ":hs:n:" o; do
  case "${o}" in
    s)  secret="${OPTARG}"
        ;;
    n)  namespace="${OPTARG}"
        ;;
    h)  usage
        exit 0
        ;;
    :)  echo "Missing argument for -${OPTARG}"
        usage
        exit 1
        ;;  
    *)  echo "Unrecognised argument for -${OPTARG}"
        usage
        exit 1
        ;;
  esac
done
shift $((OPTIND - 1))

if [[ -z "${secret}" ]]; then
  echo "No secret name provided!"
  usage
  exit 1
fi

echo "Getting secret [${secret}] from namespace [${namespace}]"

result=$(kubectl get secrets -n ${namespace} -o json | jq -r --arg VAL "${secret}" '.items[] | select(.metadata.name | contains($VAL)) | [.metadata.name, .data.token] | @tsv')
echo "${result}" | while IFS=$'\t' read -r name token; do
  if [[ -z "${token}" ]]; then
      continue
  fi

  echo
  echo
  echo "${name}"
  banner
  echo "\"$(echo ${token} | base64 --decode)\""
  banner
done

